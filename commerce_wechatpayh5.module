<?php

require_once "lib/WxPay.Api.php";

function commerce_wechatpayh5_form($form, &$form_state) {

    $form['appid_field'] = array(
        '#title' => t('APPID'),
        '#type' => 'input',
        // '#value' => t(''),
        '#description'=>t('Put your APPID'),
    );

    $form['mchid_field'] = array(
        '#title' => t('MCHID'),
        '#type' => 'input',
        // '#value' => t(''),
        '#description'=>t('Put your MCHID'),
    );

    $form['key_field'] = array(
        '#title' => t('KEY'),
        '#type' => 'input',
        // '#value' => t(''),
        '#description'=>t('Put your KEY'),
    );

    $form['appsecret_field'] = array(
        '#title' => t('APPSECRET'),
        '#type' => 'input',
        // '#value' => t(''),
        '#description'=>t('Put your APPSECRET'),
    );
    
    $form['submit_button'] = array(
        '#title' => t('Need Street Field?'),
        '#type' => 'submit',
        '#value' => t('Click Here!'),
        '#description'=>t(''),
    );
  
  return $form;
}

public function commerce_wechatpayh5_redirect($trade_no, $total_fee, $body) {
    
    var $wxparams;
    
    $wxparams = new WxPayUnifiedOrder();
    $wxparams->SetTrade_type('MWEB');
    $wxparams->SetBody($body);
    $wxparams->SetOut_trade_no($trade_no);
    $wxparams->SetTotal_fee($total_fee);
        
    $result = WxPayApi::unifiedOrder($this->wxparams);

    header('Location: '.$result['mweb_url']);
}

public function commerce_wechatpayh5_getlink($trade_no, $total_fee, $body) {
    
    var $wxparams;
    
    $wxparams = new WxPayUnifiedOrder();
    $wxparams->SetTrade_type('MWEB');
    $wxparams->SetBody($body);
    $wxparams->SetOut_trade_no($trade_no);
    $wxparams->SetTotal_fee($total_fee);
        
    $result = WxPayApi::unifiedOrder($this->wxparams);

    return $result['mweb_url'];
}